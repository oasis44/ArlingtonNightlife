<template>
	<div class="page" data-name="main">

	  <!-- Top Navbar -->
	  <div class="navbar">
		<div class="navbar-inner">
		  <div class="title">Arlington Nightlife</div>
		</div>
	  </div>

	  <!-- Toolbar -->
	  <div class="toolbar">
		<div class="toolbar-inner">
		  <!-- Toolbar links -->
		  {{#if loginData}}
			<a href="/admin" class="link">Administration</a>
			<a @click="logout" class="link">Logout</a>
		  {{else}}
		    <a href="/login" class="link">Login</a>
		  {{/if}}
		</div>
	  </div>

	  <!-- Scrollable page content -->
	  <div class="page-content">
	  
		<div class="list">
		  <ul>
			<!-- Smart select item -->
			<li>
			  <!-- Additional "smart-select" class -->
			  <a href="#" class="item-link smart-select" data-close-on-select="true">
				<!-- select -->
				<select name="eventSelect">
				  <option value="All Events" selected>All</option>
				  <option value="Happy Hour" selected>Happy Hours</option>
				  <option value="Live Music Event">Live Music</option>
				  <option value="Other Event">Other Events</option>
				</select>
				<div class="item-content" id="events">
				  <div class="item-inner">
					<!-- Select label -->
					<div class="item-title">Event Type</div>
					<!-- Selected value, not required -->
					<div class="item-after">Happy Hours</div>
				  </div>
				</div>
			  </a>
			</li>
		  </ul>
		</div>
		
		<div class="app-body">
			<h3>{{eventType}}</h3>
			
			<div class="data-table card">
				<table>
					<thead>
						<tr>
							<th class="label-cell sortable-cell" @click="sort('event_type')">Event Type</th>
							<th class="label-cell sortable-cell" @click="sort('venue_name')">Restaurant/Bar</th>
							<th class="label-cell sortable-cell" @click="sort('start_time')">Time</th>
						</tr>
					</thead>
					<tbody>
						{{#each events}}
							<tr>
								<td class="label-cell">{{event_type}}</td>
								<td class="label-cell"><a href="/venues/{{venue_id}}">{{venue_name}}</a></td>
								<td class="label-cell">{{start_time}} - {{end_time}}</td>
							</tr>
						{{/each}}
					</tbody>
				</table>
				
				<form id="pagination-form">
				<div class="data-table-footer">
					<div class="data-table-rows-select" @change="countChange">
						Per page:
						<div class="input input-dropdown">
							<select id="result-limit">
								<option value="5">5</option>
								<option value="10" selected>10</option>
								<option value="25">25</option>
								<option value="all">All</option>
							</select>
						</div>
					</div>
					<div class="data-table-pagination">
						<span class="data-table-pagination-label">1-5 of 10</span>
						<a href="#" class="link disabled">
							<i class="icon icon-prev color-gray"></i>
						</a>
						<a href="#" class="link">
							<i class="icon icon-next color-gray"></i>
						</a>
					</div>
				</div>
				</form>
			</div>
			
			<!-- Link to another page -->
			<a href="/about/">About app</a>
		</div>
	  </div>
	</div>
</template>
<script>
	return {
		data: function () {
			var self = this;
			var app = self.$app;
			
			return {
				events: []
			}
		},
		methods: {
			fetchEvents() {
				var self = this
				
				$$('select[name="eventSelect"] option:checked').each(function () {
					var eventType = this.value
					
					self.$setState({
						eventType: eventType
					});
				
					Framework7.request.get('/api/events', {'eventType': eventType}, function (data) {
						self.$setState({
							events: JSON.parse(data)
						})
					});
				});
			},
			sort(sortBy) {
				var self = this
				var resultLimit = app.data['resultLimit'] ? app.data['resultLimit'] : 10
				
				app.data['sortBy'] = sortBy
				
				Framework7.request.get('/api/events', {'eventType': this.eventType, 'sortBy': sortBy, 'resultLimit': resultLimit}, function (data) {
					self.$setState({
						events: JSON.parse(data)
					})
				});
			},
			logout() {
				var self = this
			
				Framework7.request.get('/api/users/logout', function (data) {
					app.form.removeFormData('login')
					
					self.$setState({
						loginData: ''
					})
				});
			},
			countChange() {
				var self = this
				var e = document.getElementById("result-limit");
				var resultLimit = e.options[e.selectedIndex].value;
				var sortBy = app.data['sortBy'] ? app.data['sortBy'] : 'start_time'
				
				app.data['resultLimit'] = resultLimit
				
				Framework7.request.get('/api/events', {'eventType': this.eventType, 'sortBy': sortBy, 'resultLimit': resultLimit}, function (data) {
					self.$setState({
						events: JSON.parse(data)
					})
				});
			}
		},
		on: {
			pageInit() {
				var self = this;
				var loginData = app.form.getFormData('login')

				if (loginData) {
					self.$setState({
						loginData: loginData
					})
				}
				
				this.fetchEvents()
			},
			pageReinit() {
				this.fetchEvents()
			}
		}
	}
</script>